input:
  opcuatrigger:
    endpoint: opc.tcp://172.16.14.211:49380
    tNodeIDs:
      - '{"12": [{"node": "ns=2;s=TwinCat.AFP-DC2.D018.Shot_Counter", "group": "D018", "db": "mssql", "historian": "influx", "sqlSp": "MES_DCM_OPC_Prod_Process_limits_benthos"}]}'
    subscribeEnabled: true
    insecure: true
    tBatchNodeIDs:
      - '{"12": [{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_PRESSURE_AUTO_SCRAP","name":"PeakPressure_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SLOW_SHOT_VELOCITY_AUTO_SCRAP","name":"SlowShotVelocity_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TEMPERATURE_AUTO_SCRAP","name":"Temperature_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_VELOCITY_AUTO_SCRAP","name":"PeakVelocity_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SQUEEZE_DISTANCE_AUTO_SCRAP","name":"SqueezDistance_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TOTAL_SHOT_STROKE_AUTO_SCRAP","name":"TotalShotStroke_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.FAST_SHOT_START_POSITION_AUTO_SCRAP","name":"FastShotStartPosition_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.INTENSIFICATION_DELAY_TIME_AUTO_SCRAP","name":"IntensificationDelayTime_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PRESSURE_AT_FS_AUTO_SCRAP","name":"PressureAtFs_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.BISCUIT_AUTO_SCRAP","name":"BiscuitLength_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_PRESSURE_LSL","name":"PeakPressure_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SLOW_SHOT_VELOCITY_LSL","name":"SlowShotVelocity_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TEMPERATURE_LSL","name":"Temperature_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_VELOCITY_LSL","name":"PeakVelocity_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SQUEEZE_DISTANCE_LSL","name":"SqueezDistance_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TOTAL_SHOT_STROKE","name":"TotalShotStroke"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.FAST_SHOT_START_POSITION_LSL","name":"FastShotStartPosition_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.INTENSIFICATION_DELAY_TIME_LSL","name":"IntensificationDelayTime_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PRESSURE_AT_FS_LSL","name":"PressureAtFs_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.BISCUIT_LENGTH_LSL","name":"BiscuitLength_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_PRESSURE","name":"PeakPressure"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SLOW_SHOT_VELOCITY","name":"SlowShotVelocity"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TEMPERATURE","name":"Temperature"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_VELOCITY","name":"PeakVelocity"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SQUEEZE_DISTANCE","name":"SqueezDistance"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TOTAL_SHOT_STROKE_LSL","name":"TotalShotStroke_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.FAST_SHOT_START_POSITION","name":"FastShotStartPosition"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.INTENSIFICATION_DELAY_TIME","name":"IntensificationDelayTime"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PRESSURE_AT_FS","name":"PressureAtFs"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.BISCUIT_LENGTH","name":"BiscuitLength"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_PRESSURE_USL","name":"PeakPressure_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SLOW_SHOT_VELOCITY_USL","name":"SlowShotVelocity_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TEMPERATURE_USL","name":"Temperature_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PEAK_VELOCITY_USL","name":"PeakVelocity_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.SQUEEZE_DISTANCE_USL","name":"SqueezDistance_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.TOTAL_SHOT_STROKE_USL","name":"TotalShotStroke_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.FAST_SHOT_START_POSITION_USL","name":"FastShotStartPosition_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.INTENSIFICATION_DELAY_TIME_USL","name":"IntensificationDelayTime_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.PRESSURE_AT_FS_USL","name":"PressureAtFs_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.BISCUIT_LENGTH_USL","name":"BiscuitLength_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Machine","name":"Machine"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.CYCLE_TIME","name":"cycleTime"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Auto_scrap","name":"autoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Auto_Scrap_Reason","name":"autoScrapReason"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Slow_Shot_Velocity","name":"averageSlowShotVelocity"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Slow_Shot_Velocity_LSL","name":"averageSlowShotVelocity_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Slow_Shot_Velocity_USL","name":"averageSlowShotVelocity_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Slow_Shot_Velocity_Auto_Scrap","name":"averageSlowShotVelocity_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Jog_Velocity","name":"averageJogVelocity"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Jog_Velocity_LSL","name":"averageJogVelocity_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Jog_Velocity_USL","name":"averageJogVelocity_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Jog_Velocity_Auto_Scrap","name":"averageJogVelocity_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Fast_Shot_Velocity","name":"averageFastShotVelocity"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Fast_Shot_Velocity_LSL","name":"averageFastShotVelocity_LSL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Fast_Shot_Velocity_USL","name":"averageFastShotVelocity_USL"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Average_Fast_Shot_Velocity_Auto_Scrap","name":"averageFastShotVelocity_AutoScrap"},{"node":"ns=2;s=TwinCat.AFP-DC2.D018.Shot_Counter","name":"Shot_Counter"}]}'
pipeline:
  processors:
    - bloblang: |
        root = meta("Message").parse_json()
        root.value = this
        root.timestamp_ms = (timestamp_unix_nano() / 1000000).floor()
        root.trigger = meta("opcua_path")
        root.group = meta("group")
        root.db = meta("db")
        root.historian = meta("historian")
        root.sqlSp = meta("sqlSp")

        let one = "%s%s='%s'".format("@", "group", meta("group"))
        let two = "%s%s=%s".format("@", "timestamp_ms", root.timestamp_ms.string())
        let three = "%s%s=%s".format("@", "value", root.value)
        let gmeta = "%s, %s, %s".format($one,$two,$three)

        meta spq = "exec " + meta("sqlSp")+ " " + jsontosp(meta("Message")) + $gmeta
        let g = "exec " + meta("sqlSp")+ " " + jsontosp(meta("Message"))  + $gmeta
        root.query = $g
output:
  broker:
    pattern: fan_out
    outputs:
      - mqtt:
          urls:
            - tcp://10.2.0.6:1883
          topic: UMH/V1/AFP/DCM/TEMP/${! meta("group") }
          user: "admin"
          password: "admin123"
          client_id: "afp-trigger"
      - sql_raw:
          driver: "mssql" # No default (required)
          dsn: "sqlserver://rcmmes:rcmmes384@10.0.0.18:1433?database=AFp_MES_DB"
          query: ${!meta("spq")}
          unsafe_dynamic_query: true
      - influxdb:
          endpoint: http://10.2.0.6:8086
          username: admin
          password: admin123
          token: BSNnByRccLkjEULGg1aA78tO0uGgwk2uJLz6EUlw1qh5uIFG9jmkDV8dW6tPQQExiVIITNDlpywJ8HoWEgLbuQ==
          org: RCM
          bucket: UMH_V1_AFP_DCM_trigger
          precision: ns